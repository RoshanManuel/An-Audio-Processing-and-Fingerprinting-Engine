#include <iostream>
#include <portaudio.h>
#include <vector>
constexpr int SAMPLE_RATE = 44100;
constexpr int FRAMES_PER_BUFFER = 256;
std::vector<float> audio_buffer;
static int audioCallback(const void *input,void *output,unsigned long frameCount,const PaStreamCallbackTimeInfo* timeInfo,PaStreamCallbackFlags statusFlags,void *userData) {
const float *in = static_cast<const float *>(input);
    if (!in) {
        return paContinue;
    }
    for (unsigned long i=0;i<frameCount;i++) {
        const float mono = (0.5f * (in[i*2]+in[i*2+1]));
    }
    return paContinue;
}
int main() {
    PaError err = Pa_Initialize();
    if (err != paNoError) {
        std::cerr << "PaInitialize failed: " << Pa_GetErrorText(err) << std::endl;
        Pa_Terminate();
        return 1;
    }
    const int inDevNum = Pa_GetDefaultInputDevice();
    //const int outDevNum = Pa_GetDefaultOutputDevice();
    PaStreamParameters inputParameters{};
    inputParameters.device = inDevNum;
    inputParameters.channelCount = 2;
    inputParameters.sampleFormat = paFloat32;
    inputParameters.hostApiSpecificStreamInfo = nullptr;
    inputParameters.suggestedLatency = Pa_GetDeviceInfo(inDevNum)->defaultLowInputLatency;

    //PaStreamParameters outputParameters{};
    PaStream *stream = nullptr;
    err = Pa_OpenStream(&stream, &inputParameters, nullptr, SAMPLE_RATE, FRAMES_PER_BUFFER,paNoFlag, audioCallback, nullptr);
    if (err != paNoError) {
        std::cerr << "Pa_OpenStream failed: " << Pa_GetErrorText(err) << std::endl;
        return 1;
    }
    err = Pa_StartStream(stream);
    if (err!=paNoError) {
        std::cerr << "Pa_StartStream failed: " << Pa_GetErrorText(err) << std::endl;
        Pa_CloseStream(stream);
        Pa_Terminate();
        return 1;
    }
    std::cout << "Stream started. Press ENTER to stop" << std::endl;
    std::cin.get();
    err = Pa_StopStream(stream);
    if (err!=paNoError) {
        std::cerr << "Pa_StopStream failed: " << Pa_GetErrorText(err) << std::endl;
    }

    Pa_CloseStream(stream);
    Pa_Terminate();
    return 0;
}
